# Lazy-load completions for better shell startup performance
# Completions are loaded on first use of each command
# This file is zsh-specific - skip if not running zsh

[[ -z "$ZSH_VERSION" ]] && return

# Docker completion
if type docker > /dev/null 2>&1; then
  docker() {
    unfunction docker
    source <(command docker completion zsh) 2>/dev/null
    command docker "$@"
  }
fi

# Stern completion
if type stern > /dev/null 2>&1; then
  stern() {
    unfunction stern
    source <(command stern --completion=zsh) 2>/dev/null
    command stern "$@"
  }
fi

# Kubectl completion
if type kubectl > /dev/null 2>&1; then
  kubectl() {
    unfunction kubectl
    source <(command kubectl completion zsh) 2>/dev/null
    command kubectl "$@"
  }
fi

# Kops completion
if type kops > /dev/null 2>&1; then
  kops() {
    unfunction kops
    source <(command kops completion zsh) 2>/dev/null
    command kops "$@"
  }
fi

# Kind completion
if type kind > /dev/null 2>&1; then
  kind() {
    unfunction kind
    source <(command kind completion zsh) 2>/dev/null
    command kind "$@"
  }
fi

# Chezmoi completion
if type chezmoi > /dev/null 2>&1; then
  chezmoi() {
    unfunction chezmoi
    source <(command chezmoi completion zsh) 2>/dev/null
    command chezmoi "$@"
  }
fi

# Ngrok completion
if type ngrok > /dev/null 2>&1; then
  ngrok() {
    unfunction ngrok
    source <(command ngrok completion) 2>/dev/null
    command ngrok "$@"
  }
fi

# OrbStack completion (always load as it's lightweight)
if type orbctl > /dev/null 2>&1; then
  source ~/.orbstack/shell/init.zsh 2>/dev/null || :
fi

__aws_sso_profile_complete() {
  local _args=${AWS_SSO_HELPER_ARGS:- -L error}
  _multi_parts : "($(/opt/homebrew/bin/aws-sso ${=_args} list --csv Profile))"
}

aws-sso-profile() {
  local _args=${AWS_SSO_HELPER_ARGS:- -L error}
  if [ -n "$AWS_PROFILE" ]; then
    echo "Unable to assume a role while AWS_PROFILE is set"
    return 1
  fi

  if [ -z "$1" ]; then
    echo "Usage: aws-sso-profile <profile>"
    return 1
  fi

  eval $(/opt/homebrew/bin/aws-sso ${=_args} eval -p "$1")
  if [ "$AWS_SSO_PROFILE" != "$1" ]; then
    return 1
  fi
}

aws-sso-clear() {
  local _args=${AWS_SSO_HELPER_ARGS:- -L error}
  if [ -z "$AWS_SSO_PROFILE" ]; then
    echo "AWS_SSO_PROFILE is not set"
    return 1
  fi
  eval $(/opt/homebrew/bin/aws-sso ${=_args} eval -c)
}

compdef __aws_sso_profile_complete aws-sso-profile 2>/dev/null
