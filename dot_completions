# Lazy-load completions for better shell startup performance
# Completions are loaded on first use of each command

# Docker completion
if type docker > /dev/null ; then
  docker() {
    unfunction docker
    source <(command docker completion zsh)
    docker "$@"
  }
fi

# Stern completion
if type stern > /dev/null ; then
  stern() {
    unfunction stern
    source <(command stern --completion=zsh)
    stern "$@"
  }
fi

# Kubectl completion
if type kubectl > /dev/null ; then
  kubectl() {
    unfunction kubectl
    source <(command kubectl completion zsh)
    kubectl "$@"
  }
fi

# Kops completion
if type kops > /dev/null ; then
  kops() {
    unfunction kops
    source <(command kops completion zsh)
    kops "$@"
  }
fi

# Kind completion
if type kind > /dev/null ; then
  kind() {
    unfunction kind
    source <(command kind completion zsh)
    kind "$@"
  }
fi

# Chezmoi completion
if type chezmoi > /dev/null ; then
  chezmoi() {
    unfunction chezmoi
    source <(command chezmoi completion zsh)
    chezmoi "$@"
  }
fi

# Ngrok completion
if type ngrok > /dev/null; then
  ngrok() {
    unfunction ngrok
    source <(command ngrok completion)
    ngrok "$@"
  }
fi

# OrbStack completion (always load as it's lightweight)
if type orbctl > /dev/null ; then
  source ~/.orbstack/shell/init.zsh 2>/dev/null || :
fi

__aws_sso_profile_complete() {
     local _args=${AWS_SSO_HELPER_ARGS:- -L error}
    _multi_parts : "($(/opt/homebrew/bin/aws-sso ${=_args} list --csv Profile))"
}

aws-sso-profile() {
  local _args=${AWS_SSO_HELPER_ARGS:- -L error}
  if [ -n "$AWS_PROFILE" ]; then
    echo "Unable to assume a role while AWS_PROFILE is set"
    return 1
  fi

  if [ -z "$1" ]; then
    echo "Usage: aws-sso-profile <profile>"
    return 1
  fi

  eval $(/opt/homebrew/bin/aws-sso ${=_args} eval -p "$1")
  if [ "$AWS_SSO_PROFILE" != "$1" ]; then
    return 1
  fi
}

aws-sso-clear() {
  local _args=${AWS_SSO_HELPER_ARGS:- -L error}
  if [ -z "$AWS_SSO_PROFILE" ]; then
    echo "AWS_SSO_PROFILE is not set"
    return 1
  fi
  eval $(/opt/homebrew/bin/aws-sso ${=_args} eval -c)
}

compdef __aws_sso_profile_complete aws-sso-profile
