#!/bin/sh
# GITBUTLER_MANAGED_HOOK_V1
# This hook is managed by GitButler to prevent accidental commits on the workspace branch.
# Your original pre-commit hook has been preserved as 'pre-commit-user'.

HOOKS_DIR=$(dirname "$0")

# Run user's hook first if it exists - if it fails, stop here
if [ -x "$HOOKS_DIR/pre-commit-user" ]; then
    "$HOOKS_DIR/pre-commit-user" "$@" || exit $?
fi

# Get the current branch name
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

if [ "$BRANCH" = "gitbutler/workspace" ]; then
    echo ""
    echo "GITBUTLER_ERROR: Cannot commit directly to gitbutler/workspace branch."
    echo ""
    echo "GitButler manages commits on this branch. Please use GitButler to commit your changes:"
    echo "  - Use the GitButler app to create commits"
    echo "  - Or run 'but commit' from the command line"
    echo ""
    echo "If you want to exit GitButler mode and use normal git:"
    echo "  - Run 'but teardown' to switch to a regular branch"
    echo "  - Or directly checkout another branch: git checkout <branch>"
    echo ""
    echo "If you no longer have the GitButler CLI installed, you can simply remove this hook and checkout another branch:"
    printf '  rm "%s/pre-commit"\n' "$HOOKS_DIR"
    echo ""
    exit 1
fi

# Not on workspace branch - run user's original hook if it exists
if [ -x "$HOOKS_DIR/pre-commit-user" ]; then
    echo ""
    echo "WARNING: GitButler's pre-commit hook is still installed but you're not on gitbutler/workspace."
    echo "If you're no longer using GitButler, you can restore your original hook:"
    printf '  mv "%s/pre-commit-user" "%s/pre-commit"\n' "$HOOKS_DIR" "$HOOKS_DIR"
    echo ""
fi

exit 0
