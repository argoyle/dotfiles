# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

fpath=($HOMEBREW_PREFIX/share/zsh-completions $HOMEBREW_PREFIX/share/zsh/site-functions $fpath)

for file in ~/.{functions,exports,paths,prompt,aliases,extra,auths,historyopts,completions}; do
  [ -r "$file" ] && [ -f "$file" ] && source "$file";
done

function powerline_precmd() {
    ZLE_RPROMPT_INDENT=-1
    eval "$($(go env GOPATH)/bin/powerline-go -error $? -shell zsh -eval -cwd-max-depth 4 -git-mode compact -modules ssh,cwd,exit -modules-right git,hg,aws,kube)"
}

function install_powerline_precmd() {
  for s in "${precmd_functions[@]}"; do
    if [ "$s" = "powerline_precmd" ]; then
      return
    fi
  done
  precmd_functions+=(powerline_precmd)
}

if [ "$TERM" != "linux" ]; then
    install_powerline_precmd
fi

source $HOMEBREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
source $HOMEBREW_PREFIX/share/zsh-history-substring-search/zsh-history-substring-search.zsh

zstyle ':completion:*' matcher-list '' 'm:{[:lower:][:upper:]}={[:upper:][:lower:]}' '+l:|=* r:|=*'
zstyle ':completion:*' ignored-patterns 'kubectl.docker'

# Faster! (?)
zstyle ':completion::complete:*' use-cache 1

# case insensitive completion
#zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# color code completion!!!!  Wohoo!
zstyle ':completion:*' list-colors "=(#b) #([0-9]#)*=36=31"

eval "$(direnv hook zsh)"

autoload -Uz compinit && compinit -i

{{- if ne .chezmoi.hostname "A6436902" }}
# Defer Google Cloud SDK loading for better startup performance
# Load in background after shell is interactive
() {
  local gcloud_path="$HOMEBREW_PREFIX/Caskroom/google-cloud-sdk/latest/google-cloud-sdk"
  if [[ -f "$gcloud_path/path.zsh.inc" ]]; then
    # Source path immediately (lightweight)
    source "$gcloud_path/path.zsh.inc"
    # Defer completion loading (heavier)
    if [[ -f "$gcloud_path/completion.zsh.inc" ]]; then
      # Load completion in background after a short delay
      (sleep 0.1 && source "$gcloud_path/completion.zsh.inc") &!
    fi
  fi
}
{{- end }}

# Lazy-load pyenv for better startup performance
# Set up PATH and shims, but defer full initialization until first use
if command -v pyenv 1>/dev/null 2>&1; then
  export PYENV_ROOT="$HOME/.pyenv"
  export PATH="$PYENV_ROOT/bin:$PATH"

  # Create wrapper function that loads pyenv on first use
  pyenv() {
    unfunction pyenv
    eval "$(command pyenv init -)"
    if which pyenv-virtualenv-init > /dev/null; then
      eval "$(pyenv virtualenv-init -)"
    fi
    pyenv "$@"
  }
fi

# Defer SDKMAN loading for better startup performance
# Load in background after shell is interactive
export SDKMAN_DIR="/Users/argoyle/.sdkman"
if [[ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ]]; then
  # Load SDKMAN in background after a short delay
  (sleep 0.1 && source "$SDKMAN_DIR/bin/sdkman-init.sh") &!
fi

autoload -U +X bashcompinit && bashcompinit
autoload -U zmv
complete -o nospace -C terraform terraform

set -o emacs

# Initialize fnm (Fast Node Manager)
if command -v fnm &> /dev/null; then
  eval "$(fnm env --use-on-cd)"
fi

[[ -z "$TMUX" && ("$TERM" == "rio" || "$TERM" == "alacritty" || "$TERM" == "xterm-256color" || "$TERM" == "xterm-ghostty") ]] && { tmux attach || exec tmux new-session && exit; }

typeset -U path
typeset -U manpath

fpath+=~/.zfunc; autoload -Uz compinit; compinit
